#Game play and database interactions to go here.

#Add Crew To Train
SET @player = 'Thomas';
SET @playerTrain = 3;
INSERT INTO TrainCrews VALUES (@playerTrain, @player, DEFAULT);

#Remove Crew From Train
#DELETE FROM TrainCrews WHERE OnTrain = @playerTrain;

#Display User Train:
SELECT 
    t.TrainNumber,
    t.LeadPower,
    t.DCCAddress,
    c.WithCrew,
    l.onModule,
    l.TimeUpdated
FROM
    Trains t,
    TrainCrews c,
    TrainLocations l
WHERE
    t.TrainNumber = c.OnTrain
        AND t.TrainNumber = l.TrainNumber
        AND t.TrainNumber = @playerTrain;
		
#Display Train Consist:		
SELECT 
    r.CarID,
    r.CarType,
    s.ProductType,
    (CASE
        WHEN
            s.ShipmentID IN (SELECT 
                    ShipmentID
                FROM
                    ShipmentsPickedUp
                WHERE
                    ShipmentID = s.ShipmentID)
                AND s.ShipmentID IN (SELECT 
                    ShipmentID
                FROM
                    ShipmentsDelivered
                WHERE
                    ShipmentID = s.ShipmentID)
        THEN
            (SELECT 
                    @nextDestination:=(SELECT 
                                ReturnToYard
                            FROM
                                Waybills
                            WHERE
                                UsingShipmentID = s.ShipmentID)
                )
        WHEN
            s.ShipmentID NOT IN (SELECT 
                    ShipmentID
                FROM
                    ShipmentsPickedUp
                WHERE
                    ShipmentID = s.ShipmentID)
        THEN
            (SELECT 
                    @nextDestination:=(SELECT 
                                FromIndustry
                            FROM
                                Shipments
                            WHERE
                                ShipmentID = s.ShipmentID)
                )
        WHEN
            s.ShipmentID IN (SELECT 
                    ShipmentID
                FROM
                    ShipmentsPickedUp
                WHERE
                    ShipmentID = s.ShipmentID)
        THEN
            (SELECT 
                    @nextDestination:=(SELECT 
                                ToIndustry
                            FROM
                                Shipments
                            WHERE
                                ShipmentID = s.ShipmentID)
                )
    END) AS NextDestination,
    IF(@nextDestination IN (SELECT 
                IndustryName
            FROM
                Industries
            WHERE
                IndustryName = @nextDestination),
        (SELECT 
                OnModule
            FROM
                Industries
            WHERE
                IndustryName = @nextDestination),
        (SELECT 
                OnModule
            FROM
                Yards
            WHERE
                YardName = @nextDestination)) AS Module
FROM
    RollingStockCars r,
    Waybills w,
    Shipments s
WHERE
    r.CarID = w.OnCar
        AND w.UsingShipmentID = s.ShipmentID
        AND OnCar IN (SELECT 
            UsingCar
        FROM
            ConsistedCars
        WHERE
            OnTrain = @playerTrain);

#Display List of Modules:
SET @playerModule = 'Chesterfield';
SELECT 
    *
FROM
    Modules
WHERE
    ModuleName IN (SELECT 
            ModuleName
        FROM
            ModulesAvailable
        WHERE
            IsAvailable = TRUE);
			
#Display Module:
SELECT 
    *
FROM
    Industries
WHERE
    IndustryName IN (SELECT 
            IndustryName
        FROM
            IndustriesAvailable
        WHERE
            IsAvailable = TRUE)
        AND OnModule = @playerModule;

#Check-In at Module (Move Train)
UPDATE TrainLocations SET OnModule = @playerModule WHERE TrainNumber = @playerTrain;	
		
#Display Industry:
SET @playerIndustry = 'Puget Warehouse';
SELECT 
    s.*, p.UsingProductType
FROM
    IndustrySidings s
        JOIN
    IndustryProducts p ON s.ForIndustry = p.ForIndustry
WHERE
    p.UsingProductType NOT IN (SELECT 
            ForProductType
        FROM
            SidingAssignments
        WHERE
            ForIndustry = @playerIndustry)
        AND s.SidingNumber NOT IN (SELECT 
            SidingNumber
        FROM
            SidingAssignments
        WHERE
            ForIndustry = @playerIndustry)
        AND s.ForIndustry = @playerIndustry 
UNION SELECT 
    s.*, p.UsingProductType
FROM
    IndustrySidings s
        JOIN
    IndustryProducts p ON s.ForIndustry = p.ForIndustry
WHERE
    p.UsingProductType IN (SELECT 
            ForProductType
        FROM
            SidingAssignments
        WHERE
            ForIndustry = @playerIndustry)
        AND s.SidingNumber IN (SELECT 
            SidingNumber
        FROM
            SidingAssignments
        WHERE
            ForIndustry = @playerIndustry)
        AND s.ForIndustry = @playerIndustry;

#Load Rolling Stock (formerly Deliver Rolling Stock)
SET @playerCar = 'AL';
CALL LoadRollingStock(@playerIndustry, @playerCar);

#Display Rolling Stock At Industry:	
SELECT 
    c.CarID, c.CarType, i.AtIndustry, i.TimeArrived
FROM
    RollingStockCars c
        JOIN
    RollingStockAtIndustries i ON c.CarID = i.CarID
WHERE
    i.AtIndustry = @playerIndustry;





